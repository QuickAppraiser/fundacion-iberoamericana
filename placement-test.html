<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test de Nivel CEFR | Fundación Iberoamericana</title>
    <meta name="description" content="Descubre tu nivel de inglés con nuestro test de nivel alineado al Marco Común Europeo (CEFR). Resultados inmediatos A1-C1.">
    <meta name="theme-color" content="#00BFA6">
    <link rel="canonical" href="https://quickappraiser.github.io/fundacion-iberoamericana/placement-test.html">
    <meta property="og:title" content="Test de Nivel CEFR | Fundación Iberoamericana">
    <meta property="og:description" content="Descubre tu nivel de inglés con nuestro test de nivel alineado al Marco Común Europeo (CEFR). Resultados inmediatos A1-C1.">
    <meta property="og:url" content="https://quickappraiser.github.io/fundacion-iberoamericana/placement-test.html">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://quickappraiser.github.io/fundacion-iberoamericana/icons/icon-512.svg">
    <meta name="twitter:card" content="summary">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="icons/icon-192.svg">
    <link rel="apple-touch-icon" href="icons/icon-192.svg">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css">
    <style>
        /* ====== PLACEMENT TEST STYLES ====== */
        .pt-container {
            padding-top: 100px;
            max-width: 780px;
            margin: 0 auto;
            padding-left: 2rem;
            padding-right: 2rem;
            padding-bottom: 80px;
            min-height: 100vh;
        }

        .pt-hero {
            text-align: center;
            margin-bottom: 40px;
        }
        .pt-hero h1 {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 2.2rem;
            font-weight: 800;
            color: var(--text);
            margin-bottom: 12px;
        }
        .pt-hero h1 span { color: var(--teal); }
        .pt-hero p {
            color: var(--text-light);
            font-size: 1.05rem;
            max-width: 540px;
            margin: 0 auto;
            line-height: 1.6;
        }

        /* Info cards */
        .pt-info-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 32px;
        }
        .pt-info-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 20px 16px;
            text-align: center;
        }
        .pt-info-card i {
            font-size: 1.5rem;
            color: var(--teal);
            margin-bottom: 8px;
        }
        .pt-info-card h4 {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-weight: 700;
            color: var(--text);
            font-size: 0.95rem;
            margin-bottom: 4px;
        }
        .pt-info-card p {
            color: var(--text-light);
            font-size: 0.82rem;
        }

        /* Start button */
        .pt-start-btn {
            display: block;
            width: 100%;
            max-width: 360px;
            margin: 0 auto;
            padding: 16px 32px;
            background: linear-gradient(135deg, var(--teal), var(--teal-dark));
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
        }
        .pt-start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,191,166,0.3);
        }

        /* Progress bar */
        .pt-progress {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
        }
        .pt-progress-bar {
            flex: 1;
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }
        .pt-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--teal), #4DD0E1);
            border-radius: 4px;
            transition: width 0.4s ease;
        }
        .pt-progress-text {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-light);
            white-space: nowrap;
        }
        .pt-level-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            font-family: 'Plus Jakarta Sans', sans-serif;
            color: white;
        }

        /* Question card */
        .pt-question-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 32px;
            box-shadow: var(--shadow);
            animation: fadeInUp 0.4s ease;
        }
        .pt-question-num {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--teal);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        .pt-question-text {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 24px;
            line-height: 1.5;
        }

        /* Options */
        .pt-options { display: flex; flex-direction: column; gap: 12px; }
        .pt-option {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 18px;
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition);
            font-family: 'DM Sans', sans-serif;
            font-size: 1rem;
            color: var(--text);
        }
        .pt-option:hover {
            border-color: var(--teal);
            background: rgba(0,191,166,0.05);
        }
        .pt-option.selected {
            border-color: var(--teal);
            background: rgba(0,191,166,0.08);
        }
        .pt-option-letter {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.85rem;
            font-family: 'Plus Jakarta Sans', sans-serif;
            color: var(--text-light);
            flex-shrink: 0;
            transition: var(--transition);
        }
        .pt-option.selected .pt-option-letter {
            background: var(--teal);
            color: white;
        }

        /* Next button */
        .pt-next-btn {
            margin-top: 24px;
            padding: 12px 32px;
            background: var(--teal);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            float: right;
        }
        .pt-next-btn:hover { background: var(--teal-dark); }
        .pt-next-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Results */
        .pt-results {
            text-align: center;
            animation: fadeInUp 0.5s ease;
        }
        .pt-result-badge {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            position: relative;
        }
        .pt-result-badge::before {
            content: '';
            position: absolute;
            inset: -6px;
            border-radius: 50%;
            border: 3px dashed rgba(255,255,255,0.3);
            animation: spin 20s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .pt-result-level {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 3rem;
            font-weight: 800;
            color: white;
            text-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .pt-result-title {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 1.6rem;
            font-weight: 800;
            color: var(--text);
            margin-bottom: 8px;
        }
        .pt-result-desc {
            color: var(--text-light);
            font-size: 1rem;
            max-width: 480px;
            margin: 0 auto 32px;
            line-height: 1.6;
        }

        /* Score breakdown */
        .pt-breakdown {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-bottom: 32px;
        }
        .pt-bd-item {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 14px 8px;
            text-align: center;
        }
        .pt-bd-level {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-weight: 700;
            font-size: 0.85rem;
            margin-bottom: 4px;
        }
        .pt-bd-score {
            font-size: 0.8rem;
            color: var(--text-light);
        }
        .pt-bd-item.highlight {
            border-color: var(--teal);
            background: rgba(0,191,166,0.06);
        }

        /* Action buttons */
        .pt-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .pt-action-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            border-radius: var(--radius-sm);
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            border: none;
        }
        .pt-action-btn.primary {
            background: var(--teal);
            color: white;
        }
        .pt-action-btn.primary:hover {
            background: var(--teal-dark);
            transform: translateY(-2px);
        }
        .pt-action-btn.secondary {
            background: var(--bg);
            color: var(--text);
            border: 1px solid var(--border);
        }
        .pt-action-btn.secondary:hover {
            border-color: var(--teal);
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Timer */
        .pt-timer {
            display: flex;
            align-items: center;
            gap: 6px;
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-light);
        }
        .pt-timer i { color: var(--teal); }

        /* Responsive */
        @media (max-width: 600px) {
            .pt-info-grid { grid-template-columns: 1fr; }
            .pt-breakdown { grid-template-columns: repeat(3, 1fr); }
            .pt-hero h1 { font-size: 1.6rem; }
            .pt-question-card { padding: 20px; }
            .pt-question-text { font-size: 1.05rem; }
            .pt-result-badge { width: 120px; height: 120px; }
            .pt-result-level { font-size: 2.2rem; }
        }
    </style>
</head>
<body>

<!-- NAVBAR -->
<nav class="navbar">
    <div class="navbar-inner">
        <a href="index.html" class="logo">
            <div class="logo-icon">FI</div>
            <div class="logo-text">Fundación <span>Iberoamericana</span></div>
        </a>
        <ul class="nav-links" id="navLinks">
            <li><a href="index.html">Inicio</a></li>
            <li><a href="index.html#cursos">Cursos</a></li>
            <li><a href="dashboard.html">Mi Aula</a></li>
            <li><a href="quizzes.html">Quizzes</a></li>
            <li><a href="labs.html">Labs</a></li>
            <li><a href="recursos.html">Recursos</a></li>
            <li><button id="darkModeToggle" onclick="toggleDarkMode()" style="background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:white;padding:6px 14px;border-radius:8px;cursor:pointer;font-size:1rem;" title="Modo oscuro"><i class="fas fa-moon"></i></button></li>
            <li><button id="langToggle" onclick="toggleIdioma()" style="background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:white;padding:6px 14px;border-radius:8px;font-weight:700;font-size:0.85rem;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;">EN</button></li>
        </ul>
        <button class="hamburger" aria-label="Abrir menú">
            <span></span><span></span><span></span>
        </button>
    </div>
</nav>

<div class="pt-container">

    <!-- ====== INTRO VIEW ====== -->
    <div id="ptIntro">
        <div class="pt-hero">
            <div style="margin-bottom:16px;">
                <span style="display:inline-block;padding:6px 16px;background:rgba(0,191,166,0.1);color:var(--teal);border-radius:20px;font-size:0.85rem;font-weight:700;font-family:'Plus Jakarta Sans',sans-serif;">
                    <i class="fas fa-language"></i> CEFR Aligned
                </span>
            </div>
            <h1>Test de Nivel de <span>Inglés</span></h1>
            <p>Descubre tu nivel según el Marco Común Europeo de Referencia (CEFR). 25 preguntas adaptativas que ajustan la dificultad según tus respuestas.</p>
        </div>

        <div class="pt-info-grid">
            <div class="pt-info-card">
                <i class="fas fa-clock"></i>
                <h4>~10 minutos</h4>
                <p>Duración estimada</p>
            </div>
            <div class="pt-info-card">
                <i class="fas fa-brain"></i>
                <h4>Adaptativo</h4>
                <p>Ajusta la dificultad</p>
            </div>
            <div class="pt-info-card">
                <i class="fas fa-certificate"></i>
                <h4>A1 — C1</h4>
                <p>Niveles evaluados</p>
            </div>
        </div>

        <!-- CEFR levels explanation -->
        <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:24px;margin-bottom:32px;">
            <h3 style="font-family:'Plus Jakarta Sans',sans-serif;font-size:1rem;font-weight:700;color:var(--text);margin-bottom:16px;">
                <i class="fas fa-layer-group" style="color:var(--teal);margin-right:8px;"></i>Niveles CEFR
            </h3>
            <div style="display:flex;flex-wrap:wrap;gap:10px;">
                <span class="pt-level-badge" style="background:#4CAF50;">A1 — Principiante</span>
                <span class="pt-level-badge" style="background:#8BC34A;">A2 — Elemental</span>
                <span class="pt-level-badge" style="background:#FF9800;">B1 — Intermedio</span>
                <span class="pt-level-badge" style="background:#F44336;">B2 — Intermedio Alto</span>
                <span class="pt-level-badge" style="background:#9C27B0;">C1 — Avanzado</span>
            </div>
        </div>

        <button class="pt-start-btn" onclick="startTest()">
            <i class="fas fa-play"></i> Comenzar Test
        </button>
    </div>

    <!-- ====== TEST VIEW ====== -->
    <div id="ptTest" style="display:none;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <div class="pt-timer">
                <i class="fas fa-stopwatch"></i>
                <span id="ptTimer">00:00</span>
            </div>
            <span id="ptCurrentLevel" class="pt-level-badge" style="background:#8BC34A;">A2</span>
        </div>

        <div class="pt-progress">
            <div class="pt-progress-bar">
                <div class="pt-progress-fill" id="ptProgressFill" style="width:0%"></div>
            </div>
            <span class="pt-progress-text" id="ptProgressText">1 / 25</span>
        </div>

        <div id="ptQuestionArea"></div>
    </div>

    <!-- ====== RESULTS VIEW ====== -->
    <div id="ptResults" style="display:none;"></div>

</div>

<footer class="footer">
    <div class="footer-inner">
        <div class="footer-brand">
            <a href="index.html" class="logo" style="margin-bottom:16px;">
                <div class="logo-icon">FI</div>
                <div class="logo-text">Fundación <span>Iberoamericana</span></div>
            </a>
            <p>Plataforma de formación técnica y profesional.</p>
        </div>
        <div>
            <h4>Plataforma</h4>
            <a href="index.html#cursos">Cursos</a>
            <a href="dashboard.html">Mi Aula</a>
            <a href="quizzes.html">Quizzes</a>
            <a href="labs.html">Labs</a>
        </div>
        <div>
            <h4>Más</h4>
            <a href="recursos.html">Recursos</a>
            <a href="calendario.html">Calendario</a>
            <a href="certificados.html">Certificados</a>
            <a href="privacidad.html">Privacidad</a>
        </div>
    </div>
    <div class="footer-bottom">
        &copy; 2026 Fundación Iberoamericana. Todos los derechos reservados.
        <br><small style="opacity:0.7;">Coordinación Académica: Dr. Mauricio Rodríguez, PhD Education</small>
    </div>
</footer>

<!-- Shared JS (dark mode, hamburger, language) -->
<script src="js/main.js"></script>
<script>
/* =====================================================
   CEFR PLACEMENT TEST ENGINE
   25 adaptive questions across A1-C1
   ===================================================== */

(function () {
    'use strict';

    /* ---------- CEFR LEVEL CONFIG ---------- */
    const LEVELS = ['A1', 'A2', 'B1', 'B2', 'C1'];
    const LEVEL_COLORS = { A1: '#4CAF50', A2: '#8BC34A', B1: '#FF9800', B2: '#F44336', C1: '#9C27B0' };
    const LEVEL_NAMES = {
        A1: 'Principiante (Beginner)',
        A2: 'Elemental (Elementary)',
        B1: 'Intermedio (Intermediate)',
        B2: 'Intermedio Alto (Upper-Intermediate)',
        C1: 'Avanzado (Advanced)'
    };
    const LEVEL_DESCRIPTIONS = {
        A1: 'Puedes entender y usar expresiones cotidianas básicas. Puedes presentarte y hacer preguntas sencillas sobre información personal.',
        A2: 'Puedes comunicarte en tareas simples y rutinarias. Puedes describir aspectos de tu entorno y necesidades inmediatas.',
        B1: 'Puedes manejar la mayoría de las situaciones al viajar. Puedes producir textos sencillos sobre temas familiares y describir experiencias.',
        B2: 'Puedes interactuar con fluidez y espontaneidad. Puedes producir textos claros y detallados sobre diversos temas y argumentar tu punto de vista.',
        C1: 'Puedes expresarte con fluidez y precisión. Puedes usar el idioma de forma flexible para fines sociales, académicos y profesionales.'
    };

    /* ---------- QUESTION BANK (5 per level = 25 total) ---------- */
    const QUESTIONS = [
        // === A1 (5 questions) ===
        {
            level: 'A1', id: 1,
            text: 'She _____ a student.',
            options: ['am', 'is', 'are', 'be'],
            correct: 1
        },
        {
            level: 'A1', id: 2,
            text: 'What is the plural of "child"?',
            options: ['childs', 'childes', 'children', 'childrens'],
            correct: 2
        },
        {
            level: 'A1', id: 3,
            text: '_____ you like coffee?',
            options: ['Are', 'Do', 'Is', 'Has'],
            correct: 1
        },
        {
            level: 'A1', id: 4,
            text: 'I go to school _____ bus.',
            options: ['in', 'on', 'by', 'with'],
            correct: 2
        },
        {
            level: 'A1', id: 5,
            text: 'My brother _____ football every Saturday.',
            options: ['play', 'plays', 'playing', 'is play'],
            correct: 1
        },

        // === A2 (5 questions) ===
        {
            level: 'A2', id: 6,
            text: 'I _____ to the cinema last night.',
            options: ['go', 'goes', 'went', 'going'],
            correct: 2
        },
        {
            level: 'A2', id: 7,
            text: 'There is _____ milk in the fridge.',
            options: ['a', 'any', 'some', 'many'],
            correct: 2
        },
        {
            level: 'A2', id: 8,
            text: 'She is _____ than her sister.',
            options: ['tall', 'taller', 'tallest', 'more tall'],
            correct: 1
        },
        {
            level: 'A2', id: 9,
            text: 'What _____ you doing right now?',
            options: ['do', 'are', 'is', 'does'],
            correct: 1
        },
        {
            level: 'A2', id: 10,
            text: 'We _____ see the doctor tomorrow.',
            options: ['going', 'are going to', 'go to', 'will to'],
            correct: 1
        },

        // === B1 (5 questions) ===
        {
            level: 'B1', id: 11,
            text: 'If it rains tomorrow, we _____ stay home.',
            options: ['would', 'will', 'can to', 'are'],
            correct: 1
        },
        {
            level: 'B1', id: 12,
            text: 'She _____ here since 2019.',
            options: ['lives', 'is living', 'has lived', 'lived'],
            correct: 2
        },
        {
            level: 'B1', id: 13,
            text: 'The report _____ by the manager yesterday.',
            options: ['wrote', 'was written', 'has written', 'is writing'],
            correct: 1
        },
        {
            level: 'B1', id: 14,
            text: 'I wish I _____ more free time.',
            options: ['have', 'had', 'having', 'will have'],
            correct: 1
        },
        {
            level: 'B1', id: 15,
            text: 'You should avoid _____ too much sugar.',
            options: ['eat', 'to eat', 'eating', 'ate'],
            correct: 2
        },

        // === B2 (5 questions) ===
        {
            level: 'B2', id: 16,
            text: 'Had I known about the delay, I _____ earlier.',
            options: ['would leave', 'would have left', 'had left', 'will leave'],
            correct: 1
        },
        {
            level: 'B2', id: 17,
            text: 'The project, _____ was due on Friday, has been postponed.',
            options: ['that', 'who', 'which', 'whom'],
            correct: 2
        },
        {
            level: 'B2', id: 18,
            text: 'Not only _____ the exam, but she also got the highest score.',
            options: ['she passed', 'did she pass', 'she did pass', 'passed she'],
            correct: 1
        },
        {
            level: 'B2', id: 19,
            text: 'By this time next year, I _____ my degree.',
            options: ['finish', 'will finish', 'will have finished', 'am finishing'],
            correct: 2
        },
        {
            level: 'B2', id: 20,
            text: 'She insisted _____ paying for dinner.',
            options: ['in', 'on', 'at', 'for'],
            correct: 1
        },

        // === C1 (5 questions) ===
        {
            level: 'C1', id: 21,
            text: 'Seldom _____ such a compelling argument in academic discourse.',
            options: ['I have encountered', 'have I encountered', 'I encountered', 'did I encountered'],
            correct: 1
        },
        {
            level: 'C1', id: 22,
            text: 'The government\'s decision, albeit controversial, _____ to be effective in reducing emissions.',
            options: ['has been proved', 'has proven', 'had been proving', 'was being proved'],
            correct: 1
        },
        {
            level: 'C1', id: 23,
            text: '_____ his extensive experience, he was surprisingly nervous during the presentation.',
            options: ['Despite', 'Although', 'However', 'Nevertheless'],
            correct: 0
        },
        {
            level: 'C1', id: 24,
            text: 'It is imperative that she _____ the report before the deadline.',
            options: ['submits', 'submit', 'submitted', 'will submit'],
            correct: 1
        },
        {
            level: 'C1', id: 25,
            text: 'The findings are _____ with previous research in the field.',
            options: ['consistent', 'persistent', 'resistant', 'insistent'],
            correct: 0
        }
    ];

    /* ---------- STATE ---------- */
    let currentQuestion = 0;
    let currentLevel = 'A2'; // Start at A2
    let answers = [];
    let scores = { A1: 0, A2: 0, B1: 0, B2: 0, C1: 0 };
    let questionOrder = [];
    let timerInterval = null;
    let elapsedSeconds = 0;
    let selectedOption = null;

    /* ---------- ADAPTIVE ALGORITHM ---------- */
    function buildAdaptiveOrder() {
        /* Start at A2. After each block of questions at a level,
           move up if ≥60% correct, move down if <40% correct, else stay.
           Ensures 5 questions per level are asked. */
        const pool = {};
        LEVELS.forEach(l => { pool[l] = QUESTIONS.filter(q => q.level === l).map(q => q.id); });

        const order = [];
        let level = 'A2';
        let levelIdx = LEVELS.indexOf(level);
        let asked = { A1: 0, A2: 0, B1: 0, B2: 0, C1: 0 };

        // Ask 5 questions at a time per level, 25 total
        while (order.length < 25) {
            const available = pool[LEVELS[levelIdx]];
            if (available.length > 0) {
                order.push(available.shift());
                asked[LEVELS[levelIdx]]++;
            }

            // After asking from current level, check if we need to move
            if (available.length === 0 || asked[LEVELS[levelIdx]] >= 5) {
                // Move to next available level
                let moved = false;
                // Try going up first, then down
                for (let i = levelIdx + 1; i < LEVELS.length; i++) {
                    if (pool[LEVELS[i]].length > 0) {
                        levelIdx = i;
                        moved = true;
                        break;
                    }
                }
                if (!moved) {
                    for (let i = levelIdx - 1; i >= 0; i--) {
                        if (pool[LEVELS[i]].length > 0) {
                            levelIdx = i;
                            moved = true;
                            break;
                        }
                    }
                }
                if (!moved) break;
            }
        }
        return order;
    }

    /* ---------- TIMER ---------- */
    function startTimer() {
        elapsedSeconds = 0;
        timerInterval = setInterval(() => {
            elapsedSeconds++;
            const m = String(Math.floor(elapsedSeconds / 60)).padStart(2, '0');
            const s = String(elapsedSeconds % 60).padStart(2, '0');
            document.getElementById('ptTimer').textContent = `${m}:${s}`;
        }, 1000);
    }
    function stopTimer() { clearInterval(timerInterval); }

    /* ---------- START TEST ---------- */
    window.startTest = function () {
        questionOrder = buildAdaptiveOrder();
        currentQuestion = 0;
        answers = [];
        scores = { A1: 0, A2: 0, B1: 0, B2: 0, C1: 0 };
        selectedOption = null;

        document.getElementById('ptIntro').style.display = 'none';
        document.getElementById('ptTest').style.display = 'block';
        document.getElementById('ptResults').style.display = 'none';

        startTimer();
        renderQuestion();
    };

    /* ---------- RENDER QUESTION ---------- */
    function renderQuestion() {
        selectedOption = null;
        const qId = questionOrder[currentQuestion];
        const q = QUESTIONS.find(x => x.id === qId);
        const levelColor = LEVEL_COLORS[q.level];

        // Update level badge
        const badge = document.getElementById('ptCurrentLevel');
        badge.textContent = q.level;
        badge.style.background = levelColor;
        currentLevel = q.level;

        // Update progress
        const pct = ((currentQuestion) / questionOrder.length) * 100;
        document.getElementById('ptProgressFill').style.width = pct + '%';
        document.getElementById('ptProgressText').textContent = `${currentQuestion + 1} / ${questionOrder.length}`;

        const letters = ['A', 'B', 'C', 'D'];
        const optionsHTML = q.options.map((opt, i) => `
            <div class="pt-option" onclick="selectOption(${i})" id="ptOpt${i}">
                <div class="pt-option-letter">${letters[i]}</div>
                <span>${opt}</span>
            </div>
        `).join('');

        document.getElementById('ptQuestionArea').innerHTML = `
            <div class="pt-question-card">
                <div class="pt-question-num">Pregunta ${currentQuestion + 1} — Nivel ${q.level}</div>
                <div class="pt-question-text">${q.text}</div>
                <div class="pt-options">${optionsHTML}</div>
                <button class="pt-next-btn" id="ptNextBtn" onclick="nextQuestion()" disabled>
                    ${currentQuestion < questionOrder.length - 1 ? 'Siguiente <i class="fas fa-arrow-right"></i>' : 'Ver Resultados <i class="fas fa-chart-bar"></i>'}
                </button>
            </div>
        `;
    }

    /* ---------- SELECT OPTION ---------- */
    window.selectOption = function (idx) {
        selectedOption = idx;
        // Clear previous selection
        for (let i = 0; i < 4; i++) {
            const el = document.getElementById('ptOpt' + i);
            if (el) el.classList.remove('selected');
        }
        const el = document.getElementById('ptOpt' + idx);
        if (el) el.classList.add('selected');
        document.getElementById('ptNextBtn').disabled = false;
    };

    /* ---------- NEXT QUESTION ---------- */
    window.nextQuestion = function () {
        if (selectedOption === null) return;

        const qId = questionOrder[currentQuestion];
        const q = QUESTIONS.find(x => x.id === qId);
        const isCorrect = selectedOption === q.correct;

        answers.push({ qId, selected: selectedOption, correct: q.correct, isCorrect, level: q.level });
        if (isCorrect) scores[q.level]++;

        currentQuestion++;

        if (currentQuestion >= questionOrder.length) {
            stopTimer();
            showResults();
        } else {
            renderQuestion();
        }
    };

    /* ---------- CALCULATE LEVEL ---------- */
    function calculateLevel() {
        /* Scoring: each level has 5 questions.
           Find the highest level where user scored ≥ 3/5 (60%).
           If no level reaches 60%, use the level with the best score ratio. */
        let determined = 'A1';
        for (let i = 0; i < LEVELS.length; i++) {
            const lv = LEVELS[i];
            if (scores[lv] >= 3) {
                determined = lv;
            }
        }
        return determined;
    }

    /* ---------- SHOW RESULTS ---------- */
    function showResults() {
        const level = calculateLevel();
        const color = LEVEL_COLORS[level];
        const totalCorrect = Object.values(scores).reduce((a, b) => a + b, 0);
        const pct = Math.round((totalCorrect / 25) * 100);

        // Save to localStorage
        try {
            localStorage.setItem('fi_cefr_level', level);
            localStorage.setItem('fi_cefr_score', JSON.stringify(scores));
            localStorage.setItem('fi_cefr_date', new Date().toISOString());
        } catch (e) { /* silent */ }

        // Breakdown HTML
        const breakdownHTML = LEVELS.map(lv => {
            const isActive = lv === level;
            return `
                <div class="pt-bd-item ${isActive ? 'highlight' : ''}">
                    <div class="pt-bd-level" style="color:${LEVEL_COLORS[lv]}">${lv}</div>
                    <div class="pt-bd-score">${scores[lv]} / 5</div>
                </div>
            `;
        }).join('');

        document.getElementById('ptTest').style.display = 'none';
        document.getElementById('ptResults').style.display = 'block';
        document.getElementById('ptProgressFill').style.width = '100%';

        const minutes = Math.floor(elapsedSeconds / 60);
        const seconds = elapsedSeconds % 60;

        document.getElementById('ptResults').innerHTML = `
            <div class="pt-results">
                <div style="margin-bottom:8px;">
                    <span style="display:inline-block;padding:6px 16px;background:rgba(0,191,166,0.1);color:var(--teal);border-radius:20px;font-size:0.85rem;font-weight:700;font-family:'Plus Jakarta Sans',sans-serif;">
                        <i class="fas fa-check-circle"></i> Test Completado
                    </span>
                </div>

                <div class="pt-result-badge" style="background:linear-gradient(135deg, ${color}, ${color}dd);">
                    <div class="pt-result-level">${level}</div>
                </div>

                <div class="pt-result-title">${LEVEL_NAMES[level]}</div>
                <div class="pt-result-desc">${LEVEL_DESCRIPTIONS[level]}</div>

                <div style="display:flex;justify-content:center;gap:24px;margin-bottom:24px;flex-wrap:wrap;">
                    <div style="text-align:center;">
                        <div style="font-size:1.8rem;font-weight:800;color:var(--teal);font-family:'Plus Jakarta Sans',sans-serif;">${totalCorrect}/25</div>
                        <div style="font-size:0.8rem;color:var(--text-light);">Respuestas correctas</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="font-size:1.8rem;font-weight:800;color:var(--teal);font-family:'Plus Jakarta Sans',sans-serif;">${pct}%</div>
                        <div style="font-size:0.8rem;color:var(--text-light);">Puntuación</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="font-size:1.8rem;font-weight:800;color:var(--teal);font-family:'Plus Jakarta Sans',sans-serif;">${minutes}:${String(seconds).padStart(2,'0')}</div>
                        <div style="font-size:0.8rem;color:var(--text-light);">Tiempo</div>
                    </div>
                </div>

                <h3 style="font-family:'Plus Jakarta Sans',sans-serif;font-size:1rem;font-weight:700;color:var(--text);margin-bottom:12px;">
                    <i class="fas fa-chart-bar" style="color:var(--teal);margin-right:6px;"></i>Desglose por Nivel
                </h3>
                <div class="pt-breakdown">${breakdownHTML}</div>

                <div class="pt-actions">
                    <a href="cursos/curso.html?id=ingles-general" class="pt-action-btn primary">
                        <i class="fas fa-book-open"></i> Ir al Curso de Inglés ${level}
                    </a>
                    <button class="pt-action-btn secondary" onclick="location.reload()">
                        <i class="fas fa-redo"></i> Repetir Test
                    </button>
                    <a href="index.html" class="pt-action-btn secondary">
                        <i class="fas fa-home"></i> Inicio
                    </a>
                </div>

                <div style="margin-top:32px;padding:16px;background:var(--bg);border-radius:var(--radius-sm);border:1px solid var(--border);">
                    <p style="font-size:0.85rem;color:var(--text-light);line-height:1.5;">
                        <i class="fas fa-info-circle" style="color:var(--teal);margin-right:6px;"></i>
                        Tu nivel ha sido guardado. Puedes verlo en el <a href="dashboard.html" style="color:var(--teal);font-weight:600;">Dashboard</a> y en tu ruta de aprendizaje de Inglés.
                        Este test es una estimación — para una evaluación oficial, consulta un centro autorizado CEFR.
                    </p>
                </div>
            </div>
        `;
    }

    /* ---------- DARK MODE & HAMBURGER COMPAT ---------- */
    document.addEventListener('DOMContentLoaded', () => {
        // Re-apply dark mode if set
        if (localStorage.getItem('theme') === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
            const btn = document.getElementById('darkModeToggle');
            if (btn) btn.innerHTML = '<i class="fas fa-sun"></i>';
        }

        // Hamburger menu
        const hamburger = document.querySelector('.hamburger');
        const navLinks = document.getElementById('navLinks');
        if (hamburger && navLinks) {
            hamburger.addEventListener('click', () => {
                navLinks.classList.toggle('active');
                hamburger.classList.toggle('active');
            });
        }

        // Check if user already has a result
        const savedLevel = localStorage.getItem('fi_cefr_level');
        if (savedLevel) {
            const savedDate = localStorage.getItem('fi_cefr_date');
            let dateStr = '';
            if (savedDate) {
                const d = new Date(savedDate);
                dateStr = ` (${d.toLocaleDateString()})`;
            }
            const heroP = document.querySelector('.pt-hero p');
            if (heroP) {
                heroP.innerHTML += `<br><br><span style="display:inline-block;padding:6px 14px;background:${LEVEL_COLORS[savedLevel]}22;color:${LEVEL_COLORS[savedLevel]};border-radius:8px;font-size:0.85rem;font-weight:600;"><i class="fas fa-user-check"></i> Tu nivel actual: <strong>${savedLevel}</strong>${dateStr}</span>`;
            }
        }
    });
})();
</script>
</body>
</html>
